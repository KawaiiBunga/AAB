name: Build Aseprite (Windows CI)

on:
  push:
  workflow_dispatch:
  schedule:
    - cron: "0 */6 * * *"

jobs:
  build:
    runs-on: windows-latest
    timeout-minutes: 180  # Skia can take a while first time

    steps:
    # ----------------------------
    # Checkout Aseprite
    # ----------------------------
    - name: Checkout Aseprite
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    # ----------------------------
    # Setup MSVC environment
    # ----------------------------
    - name: Setup MSVC
      uses: ilammy/msvc-dev-cmd@v1
      with:
        architecture: x64

    # ----------------------------
    # Install Ninja
    # ----------------------------
    - name: Install Ninja
      uses: seanmiddleditch/gha-setup-ninja@v4

    # ----------------------------
    # Setup Python
    # ----------------------------
    - name: Setup Python
      uses: actions/setup-python@v5
      with:
        python-version: "3.11"

    # ----------------------------
    # Cache depot_tools
    # ----------------------------
    - name: Cache depot_tools
      uses: actions/cache@v3
      with:
        path: depot_tools
        key: depot_tools-${{ runner.os }}

    - name: Install depot_tools
      shell: pwsh
      run: |
        if (-Not (Test-Path "depot_tools")) {
          git clone https://chromium.googlesource.com/chromium/tools/depot_tools.git
        }
        $env:PATH += ";$PWD/depot_tools"

    # ----------------------------
    # Cache Skia source
    # ----------------------------
    - name: Cache Skia source
      uses: actions/cache@v3
      with:
        path: skia
        key: skia-source-${{ runner.os }}-m121

    # ----------------------------
    # Clone Skia
    # ----------------------------
    - name: Clone Skia
      shell: pwsh
      run: |
        if (-Not (Test-Path "skia")) {
          git clone https://skia.googlesource.com/skia skia --branch chrome/m121 --single-branch
        }

    # ----------------------------
    # Initialize depot_tools & sync Skia dependencies
    # ----------------------------
    - name: Initialize depot_tools and sync Skia
      shell: pwsh
      run: |
        $env:PATH += ";$PWD/depot_tools"
        cd skia
        # Configure gclient (skip if already exists)
        if (-Not (Test-Path ".gclient")) {
          gclient config https://skia.googlesource.com/skia
        }
        gclient sync --with_branch_heads --jobs=$env:NUMBER_OF_PROCESSORS --nohooks

    # ----------------------------
    # Cache Skia build output
    # ----------------------------
    - name: Cache Skia build
      uses: actions/cache@v3
      with:
        path: skia/out/Release
        key: skia-build-${{ runner.os }}-m121
        restore-keys: |
          skia-build-${{ runner.os }}-

    # ----------------------------
    # Generate Skia build files (GN)
    # ----------------------------
    - name: Generate Skia build files
      shell: pwsh
      run: |
        cd skia
        $env:PATH += ";$PWD/../depot_tools"
        if (-Not (Test-Path "out/Release/obj")) {
          gn gen out/Release --args="is_official_build=true is_component_build=false target_cpu=\"x64\""
        }

    # ----------------------------
    # Build Skia
    # ----------------------------
    - name: Build Skia
      shell: pwsh
      run: ninja -C skia/out/Release -j $env:NUMBER_OF_PROCESSORS

    # ----------------------------
    # Configure Aseprite
    # ----------------------------
    - name: Configure Aseprite
      shell: pwsh
      run: |
        cmake -S . -B build -G Ninja `
          -DCMAKE_BUILD_TYPE=Release `
          -DLAF_BACKEND=skia `
          -DSKIA_DIR=skia `
          -DSKIA_LIBRARY_DIR=skia/out/Release `
          -DCMAKE_PREFIX_PATH=skia/out/Release

    # ----------------------------
    # Build Aseprite (non-interactive)
    # ----------------------------
    - name: Build Aseprite
      shell: pwsh
      run: cmake --build build --config Release --parallel $env:NUMBER_OF_PROCESSORS

    # ----------------------------
    # Package output (EXE + DLLs)
    # ----------------------------
    - name: Package output
      shell: pwsh
      run: |
        New-Item -ItemType Directory -Force -Path output
        Copy-Item build\bin\Release\aseprite.exe output\
        Copy-Item skia\out\Release\*.dll output\

    # ----------------------------
    # Upload artifact
    # ----------------------------
    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: aseprite-build
        path: output/
